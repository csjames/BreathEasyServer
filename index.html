<!DOCTYPE html>
<html ng-app="serverManagementModule">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LifeGuide Toolbox Admin Page</title>

    <link rel="icon" type="image/png" href="http://localhost:8080/client/img/icon.png" />

    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>

    <style>
        .vertical-center {
            min-height: 100%;
            min-height: 100vh;
            display: flex;
            align-items: top;
        }

        body {
            overflow-y: hidden;
        }
    </style>

</head>

<body>
    <div ng-controller="serverManagementCtrl as smCtrl">
        <div class="container">
            <nav class="navbar-fixed-top navbar-inverse">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#mynavbar">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#home">LifeGuide Toolbox <sup>&copy;</sup></a>
                    </div>
                    <div id="mynavbar" class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="#home"><span class="glyphicon glyphicon-home"></span> Home</a></li>
                            <li ng-show="smCtrl.checkAuthentication()"><a href="#dashboard"><span class="glyphicon glyphicon-wrench"></span> Dashboard</a></li>
                            <li><a href="#login"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
                            <li><a href="#about"><span class="glyphicon glyphicon-info-sign"></span> About</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="#register"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
                            <li><a href="#logout" ng-click="smCtrl.logoutUser()"><span class="glyphicon glyphicon-log-out"></span> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
        <div id="home" class="container vertical-center">
            <div class="jumbotron text-left">
                <h2>LifeGuide Toolbox Management Page</h2>
                <p class="text-justify">
                    The Lifeguide Toolbox admin tools website should be used by interventions authors to publish their interventions.
                </p>
                <p class="text-justify">
                    Please click <a href="#login">here</a> to go to the login page, if you don't have an account with us please click <a href="#register">here</a> to create an account.
                </p>
                <p class="text-justify">
                    To upload your interventions, please login to the service and upload your intervention JSON file, then please configure the LigeGuide Toolbox app to use the desired intervention file. You can only have one intervention file per application.
                </p>
                <p class="text-justify">
                    To create a new intervention JSON file please use the most recent web authoring website, available <a href="http://waisvm-lgapp.ecs.soton.ac.uk" target="_blank">here</a>.
                </p>
            </div>
        </div>

        <div id="login" class="container vertical-center">
            <div class="jumbotron">
                <ng-form name="user" class="form-horizontal">
                    <h2>Please enter your login information</h2>
                    <div class="form-group">
                        <label for="username" class="control-label col-xs-2">Username</label>
                        <div class="col-xs-10">
                            <input type="text" maxlength="20" name="username" placeholder="username" ng-model="smCtrl.user.username" id="username" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="password" class="control-label col-xs-2">Password</label>
                        <div class="col-xs-10">
                            <input type="password" maxlength="20" name="password" placeholder="password" ng-model="smCtrl.user.password" id="password" required>
                        </div>
                    </div>
                    <div class="col-xs-offset-2 col-xs-10">
                        <button type="submit" ng-click="smCtrl.loginUser(smCtrl.user)" class="btn btn-primary btn-med">Login</button>
                    </div>
                    <label><font color="red">{{smCtrl.customError}}</font></label>
                    <div class="col-xs-offset-2 col-xs-10">
                        <input type="checkbox" value="remember-me" id="rememberMe" name="rememberMe" disabled> Remember me
                    </div>
                </ng-form>
                <div class="btn-group btn-group-justified">
                    <form name="forgotenpassword" action="api/users" method="get" accept-charset="utf-8">
                        <div class="col-xs-offset-2 col-xs-10">
                            <button type="submit" class="btn btn-primary btn-med" disabled>Forgoten Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="register" class="container vertical-center">
            <div class="jumbotron">
                <form name="registration" action="api/signup" method="post" accept-charset="utf-8">
                    <h2>Registration Form</h2>
                    <div class="form-group row">
                        <label for="name" class="col-md-2 col-form-label">Name</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="name" placeholder="enter your name" ng-model="smCtrl.newuser.name" id="name" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="surname" class="col-md-2 col-form-label">Surname</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="surname" placeholder="enter your surname" ng-model="smCtrl.newuser.surname" id="surname" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="username" class="col-md-2 col-form-label">Username</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="username" placeholder="enter your name" ng-model="smCtrl.newuser.username" id="username" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="password" class="col-md-2 col-form-label">Password</label>
                        <div class="col-md-5">
                            <input class="form-control" type="password" name="password" ng-model="smCtrl.newuser.password" id="password" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="email" class="col-md-2 col-form-label">Email</label>
                        <div class="col-md-5">
                            <input class="form-control" type="email" name="email" placeholder="enter your email" ng-model="smCtrl.newuser.email" id="email" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="tel" class="col-md-2 col-form-label">Telephone</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="tel" placeholder="enter your phone number" ng-model="smCtrl.newuser.tel" id="tel">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="locaction" class="col-md-2 col-form-label">Location</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="location" placeholder="enter your city/town" ng-model="smCtrl.newuser.location" id="location">
                        </div>
                    </div>
                    <div class="col-md-offset-2 col-md-2">
                        <button type="submit" ng-click="smCtrl.registerUser(smCtrl.newuser)" class="btn btn-primary btn-med">Register</button>
                    </div>
                </form>
                <div class="btn-group btn-group-justified">

                </div>
            </div>
        </div>

        <div id="about" class="container vertical-center">
            <div class="jumbotron text-left">
                <h2 name="about">About LifeGuide Toolbox</h2>
                <p class="text-justify">
                    The LifeGuide research programme is a multidisciplinary initiative led by Professor Lucy Yardley (Psychology) and Dr Mark Weal (Computer Science) at the University of Southampton.
                </p>
                <p class="text-justify">
                    We have developed a unique set of open source software tools, the ‘LifeGuide’, that allows intervention designers with no experience of programming to create interactive web-based interventions to support healthy behaviour.
                </p>
                <p class="text-justify">
                    Using this software platform, we have been developing and successfully trialling numerous interventions for PC, tablet and smart phone, including public health interventions (e.g. for weight management, physical activity support, hand hygiene, smoking cessation) and illness management interventions (e.g. for hypertension, diabetes, cancer, back pain, dizziness, fatigue, stress, stroke, respiratory conditions, eczema and irritable bowel).
                </p>
                <p class="text-justify">
                    Our interventions are now being disseminated in the UK and internationally by the NHS, public health teams and education websites for health professionals.
                </p>
                <p class="text-justify">
                    For more information please click <a href="https://www.lifeguideonline.org" target="_blank">here</a>.
                </p>
            </div>
        </div>

        <div id="dashboard" class="container vertical-center">
            <div class="jumbotron text-center">
                <h2>Dashboard</h2>

                <div ng-show="smCtrl.checkAuthentication()">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="thead-inverse">
                                <tr>
                                    <th>#</th>
                                    <th>Intervention ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="intervention in smCtrl.interventionList.data">
                                    <td>{{$index}}</td>
                                    <td>{{intervention.key}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="form-group row">
                        <label for="interventionName" class="col-md-1 control-label">ID</label>
                        <div class="col-md-3">
                            <input type="text" id="interventionName" ng-model="smCtrl.interventionID" class="form-control" placeholder="Intervention ID" />
                        </div>
                        <div class="col-md-4">
                            <input type="file" id="file" class="form-control" />
                        </div>
                        <div>
                            <button class="btn btn-primary btn-med" ng-click="smCtrl.fileUpload()">Add Intervention</button>
                        </div>

                    </div>
                </div>

                <p class="text-justify" ng-hide="smCtrl.checkAuthentication()">
                    <strong>Please Note:</strong> You must be signed in to view this page, please click <a href="#login">here</a> to signin. If you are not registered please click <a href="#register">here</a> to register with us.
                </p>
            </div>
        </div>

        <div id="logout" class="container vertical-center">
            <div class="jumbotron text-center">
                <h2>You have successfully logged out.</h2>
                <p class="text-justify">
                    If you want to sign back in please click <a href="#login">here</a>. If you want to go to the home page please click <a href="#home">here</a>
                </p>
            </div>
        </div>

    </div>
    <footer class="footer">
        <div class="container">
            <span class="text-muted">&copy; Copyright University of Southampton 2016</span>
        </div>
    </footer>

    <script>
        (function () {
            'use strict';
            angular.module('serverManagementModule', [])
                .controller('serverManagementCtrl', function (AuthService, dataManager, $http) {
                    var vm = this;
                    vm.user = {};
                    vm.newuser = {};
                    vm.customError = null;
                    vm.fileData = {};
                    vm.interventionID = null;
                    var interventionContent = {};
                    var API_ENDPOINT = 'http://localhost:8080/api';

                    vm.search = function (val) {};

                    vm.checkAuthentication = function () {
                        return AuthService.isAuthenticated();
                    };

                    var parseInterventions = function () {

                        $http.get(API_ENDPOINT + '/interventions').then(function (result) {
                            //vm.memberinfo = result.data.msg;
                            console.log(result.data.msg);
                            vm.interventionList = result;
                        });

                    };

                    parseInterventions();

                    vm.fileUpload = function () {
                        console.info('file upload');

                        var intervention = {
                            'key': vm.interventionID,
                            'data': interventionContent
                        }

                        dataManager.saveIntervention(intervention);
                        /*
                        var file = document.getElementById('file').files[0],
                            reader = new FileReader();
                        reader.onloadend = function (e) {
                            vm.FileData = e.target.result;
                        }
                        reader.onerror = function (event) {
                            console.error('File could not be read!' + event.target.error.code);
                        };
                        */
                    };

                    /*
                        vm.openFileDialog = function () {
                            console.info('openFileDialog()');
                            ionic.trigger('click', {
                                target: document.getElementById('file')
                            });
                        };
                        */

                    angular.element(document).find('input').on('change', function (event) {
                        console.info('element change event');
                        var file = event.target.files[0];
                        vm.fileName = file.name;
                        var reader = new FileReader();
                        // Closure to capture the file information
                        reader.onload = function (event) {
                            vm.contents = event.target.result;
                            interventionContent = vm.contents;
                            console.info('File contents: ' + vm.contents);
                        };
                        reader.onerror = function (event) {
                            console.error('File could not be read!' + event.target.error.code);
                        };
                        // Read the file contents as text
                        reader.readAsText(file);
                        console.info('uploaded file: ' + vm.fileName);
                    });


                    //document.getElementById("dashboard").addEventListener('mouseover', function () {
                    //  AuthService.accessSecureArea();
                    //});

                    vm.loginUser = function (user) {
                        console.log('called from html');
                        AuthService.loginUser(user);
                    };

                    vm.registerUser = function (newuser) {
                        AuthService.registerUser(newuser);
                    };

                    vm.logoutUser = function () {
                        AuthService.logout();
                    };


                    vm.parseInterventionList = function () {
                        console.log('parse interventions');
                        AuthService.accessSecureArea();
                    };
                })

            .directive('search', function () {
                return function ($scope, element) {
                    element.bind("keyup", function (event) {
                        var val = element.val();
                        if (val.length > 2) {
                            $scope.search(val);
                        }
                    });
                };
            })

            .service('dataManager', function ($q, $http) {
                'use strict';
                var API_ENDPOINT = 'http://localhost:8080/api';

                var saveIntervention = function (data) {
                    return $q(function (resolve, reject) {
                        $http.post(API_ENDPOINT + '/saveintervention', data).then(function (result) {
                            if (result.data.success) {
                                resolve(result.data.msg);
                            } else {
                                reject(result.data.msg);
                            }
                        });
                    });
                };

                return {
                    saveIntervention: saveIntervention
                };

            })

            .service('AuthService', function ($q, $http) {

                var LOCAL_TOKEN_KEY = 'yourTokenKey';
                var username = '';
                var isAuthenticated = false;
                var role = '';
                var authToken;
                var API_ENDPOINT = 'http://localhost:8080/api';
                var AUTH_EVENTS = 'auth-not-authenticated';

                function validateForm() {
                    var x = document.forms["login"]["username"].value;
                    if (x == null || x == "") {
                        alert("Please fill out the username");
                        return false;
                    }
                }

                function loginUser(user) {
                    return $q(function (resolve, reject) {
                        $http.post(API_ENDPOINT + '/authenticate', user).then(function (result) {
                            if (result.data.success) {
                                storeUserCredentials(result.data.token);
                                console.log(result.data.token);
                                resolve(result.data.msg);

                                setTimeout(function () {
                                    console.log('parse interventions');
                                    accessSecureArea();
                                }, 1000);


                            } else {
                                reject(result.data.msg);
                                console.log(result.data.msg + user);
                                console.dir(user);

                            }
                        });
                    });
                }



                var accessSecureArea = function () {
                    //var token = window.localStorage.getItem(LOCAL_TOKEN_KEY);
                    // Set the token as header for your requests!
                    //$http.defaults.headers.common['X-Auth-Token'] = token;

                    $http.get(API_ENDPOINT + '/dashboard').then(function (result) {
                        //vm.memberinfo = result.data.msg;
                        console.log(result.data.msg);
                    });

                    /*
                    $http({
                        url: API_ENDPOINT + '/dashboard',
                        method: 'get',
                        headers: {
                            'x-access-token': token
                        }
                    }).then(function (result) {
                        vm.memberinfo = result.data.msg;
                        console.log(resul.data.msg);
                    }); */
                };

                function registerUser(user) {
                    return $q(function (resolve, reject) {
                        $http.post(API_ENDPOINT.url + '/signup', user).then(function (result) {
                            if (result.data.success) {
                                resolve(result.data.msg);
                            } else {
                                reject(result.data.msg);
                            }
                        });
                    });
                };

                function storeUserCredentials(token) {
                    window.localStorage.setItem(LOCAL_TOKEN_KEY, token);
                    useCredentials(token);
                }

                function useCredentials(token) {
                    username = token.split('.')[0];
                    isAuthenticated = true;
                    authToken = token;

                    if (username == 'admin') {
                        role = USER_ROLES.admin
                    }
                    if (username == 'user') {
                        role = USER_ROLES.public
                    }

                    // Set the token as header for your requests!
                    //$http.defaults.headers.common['X-Auth-Token'] = token;
                    $http.defaults.headers.common['authorization'] = token;
                }

                var logout = function () {
                    destroyUserCredentials();
                };

                function destroyUserCredentials() {
                    authToken = undefined;
                    username = '';
                    isAuthenticated = false;
                    $http.defaults.headers.common['authorization'] = undefined; //changed X-Auth-Token to authorization
                    window.localStorage.removeItem(LOCAL_TOKEN_KEY);
                }

                var isAuthorized = function (authorizedRoles) {
                    if (!angular.isArray(authorizedRoles)) {
                        authorizedRoles = [authorizedRoles];
                    }
                    return (isAuthenticated && authorizedRoles.indexOf(role) !== -1);
                };

                function tokenManagement() {
                    var token = window.localStorage.getItem(LOCAL_TOKEN_KEY);
                    if (token) {
                        options.headers = {
                                'x-access-token': token
                            } //changed to authorization
                    }
                }
                return {
                    loginUser: loginUser,
                    registerUser: registerUser,
                    logout: logout,
                    accessSecureArea: accessSecureArea,
                    tokenManagement: tokenManagement,
                    isAuthenticated: function () {
                        return isAuthenticated;
                    }
                };

            });

        }());
    </script>

</body>

</html>
