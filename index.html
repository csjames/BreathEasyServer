<!DOCTYPE html>
<html ng-app="serverManagementModule">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LifeGuide Toolbox Admin Page</title>

    <link rel="icon" type="image/png" href="http://re1e08-mongo-php.ecs.soton.ac.uk/frodo/client/img/icon.png" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <style>
        .vertical-center {
            min-height: 100%;
            min-height: 100vh;
            display: flex;
            align-items: top;
        }

        body {
            overflow-y: hidden;
        }

        .table-responsive {
            height: 500px !important;
            overflow: scroll;
        }

        #my_file {
            display: none;
        }
    </style>

</head>

<body>
    <div ng-controller="serverManagementCtrl as smCtrl">
        <div class="container">
            <nav class="navbar-fixed-top navbar-inverse">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#mynavbar">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#home">LifeGuide Toolbox <sup>&copy;</sup></a>
                    </div>
                    <div id="mynavbar" class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="#home"><span class="glyphicon glyphicon-home"></span> Home</a></li>
                            <li ng-show="smCtrl.checkAuthorisation()"><a href="#dashboard"><span class="glyphicon glyphicon-wrench"></span> Dashboard</a></li>
                            <li><a href="#login"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
                            <li><a href="#about"><span class="glyphicon glyphicon-info-sign"></span> About</a></li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a href="#register"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
                            <li><a href="#logout" ng-click="smCtrl.logoutUser()"><span class="glyphicon glyphicon-log-out"></span> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
        <div id="home" class="container vertical-center">
            <div class="jumbotron text-left">
                <h2>LifeGuide Toolbox Management Page</h2>
                <p class="text-justify">
                    The Lifeguide Toolbox admin tools website should be used by interventions authors to publish their interventions.
                </p>
                <p class="text-justify">
                    Please click <a href="#login">here</a> to go to the login page, if you don't have an account with us please click <a href="#register">here</a> to create an account.
                </p>
                <p class="text-justify">
                    To upload your interventions, please login to the service and upload your intervention JSON file, then please configure the LigeGuide Toolbox app to use the desired intervention file. You can only have one intervention file per application.
                </p>
                <p class="text-justify">
                    To create a new intervention JSON file please use the most recent web authoring website, available <a href="http://waisvm-lgapp.ecs.soton.ac.uk/editor" target="_blank">here</a>.
                </p>
                <span class="text-muted">&copy; Copyright University of Southampton 2017</span>
            </div>
        </div>

        <div id="login" class="container vertical-center">
            <div class="jumbotron">
                <form name="user" class="form-horizontal" ng-submit="smCtrl.loginUser(smCtrl.user)">
                    <h2>Please enter your login information</h2>
                    <div id="loginFeedback"></div>
                    <div class="form-group">
                        <label for="username" class="control-label col-md-2">Username</label>
                        <div class="col-md-2">
                            <input type="text" maxlength="20" name="username" placeholder="username" ng-model="smCtrl.user.username" id="username" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="password" class="control-label col-md-2">Password</label>
                        <div class="col-md-2">
                            <input type="password" maxlength="20" name="password" placeholder="password" ng-model="smCtrl.user.password" id="password" required>
                        </div>
                    </div>
                    <div class="col-md-offset-2 col-md-2">
                        <button type="submit" id="submit" class="btn btn-primary btn-med">Login</button>
                    </div>
                </form>
                <div class="col-md-offset-2 col-md-2">
                    <div>
                        <a href="#forgotPassword">Forgotten Password</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="forgotPassword" class="container vertical-center">
            <div class="jumbotron">
                <form name="forgot" class="form-horizontal" ng-submit="smCtrl.forgotPassword(smCtrl.forgotPasswordUsername)">
                    <h2>Please enter your user name</h2>
                    <label>User Name</label>
                    <input type="text" ng-model="smCtrl.forgotPasswordUsername" required>
                    <button type="submit">Request New Password</button>
                </form>
                <div id="forgotPasswordFeedback"></div>
            </div>
        </div>

        <div id="resetPassword" class="container vertical-center">
            <div class="jumbotron">
                <ng-form name="registration" class="form-horizontal">
                    <h2>Reset Password</h2>
                    <div class="form-group row">
                        <label for="password" class="col-md-2 col-form-label">New Password</label>
                        <div class="col-md-5">
                            <input class="form-control" type="password" name="password" ng-model="smCtrl.newPassword" id="password1" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="confirm" class="col-md-2 col-form-label">Confirm New Password</label>
                        <div class="col-md-5">
                            <input class="form-control" type="password" name="confirm" ng-model="smCtrl.newPassword" pw-check="password1" id="confirm" required>
                            <div class="msg-block" ng-show="registration.$error">
                                <span class="msg-error" ng-show="registration.confirm.$error.pwmatch" style="color:red">
                                    Must match the previous entry
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-offset-2 col-md-2">
                        <button type="submit" ng-click="smCtrl.registerUser(smCtrl.newPassword)" class="btn btn-primary btn-med">Change Password</button>
                    </div>
                </ng-form>

            </div>
        </div>

        <div id="register" class="container vertical-center">
            <div class="jumbotron">
                <ng-form name="registration" class="form-horizontal">
                    <h2>Registration Form</h2>
                    <div class="form-group row">
                        <label for="name" class="col-md-2 col-form-label">Name</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="name" placeholder="enter your name" ng-model="smCtrl.newuser.name" id="name" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="surname" class="col-md-2 col-form-label">Surname</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="surname" placeholder="enter your surname" ng-model="smCtrl.newuser.surname" id="surname" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="username" class="col-md-2 col-form-label">Username</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="username" placeholder="enter your name" ng-model="smCtrl.newuser.username" id="username" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="password" class="col-md-2 col-form-label">Password</label>
                        <div class="col-md-5">
                            <input class="form-control" type="password" name="password" ng-model="smCtrl.newuser.password" id="password1" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="confirm" class="col-md-2 col-form-label">Confirm Password</label>
                        <div class="col-md-5">
                            <input class="form-control" type="password" name="confirm" ng-model="smCtrl.newuser.confirm" pw-check="password1" id="confirm" required>
                            <div class="msg-block" ng-show="registration.$error">
                                <span class="msg-error" ng-show="registration.confirm.$error.pwmatch" style="color:red">
                                    Must match the previous entry
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="email" class="col-md-2 col-form-label">Email</label>
                        <div class="col-md-5">
                            <input class="form-control" type="email" name="email" placeholder="enter your email" ng-model="smCtrl.newuser.email" id="email" required>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="tel" class="col-md-2 col-form-label">Telephone</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="tel" placeholder="enter your phone number" ng-model="smCtrl.newuser.tel" id="tel">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="locaction" class="col-md-2 col-form-label">Location</label>
                        <div class="col-md-5">
                            <input class="form-control" type="text" name="location" placeholder="enter your city/town" ng-model="smCtrl.newuser.location" id="location">
                        </div>
                    </div>
                    <div id="registrationFeedback"></div>
                    <div class="col-md-offset-2 col-md-2">
                        <button type="submit" ng-click="smCtrl.registerUser(smCtrl.newuser)" class="btn btn-primary btn-med">Register</button>
                    </div>
                </ng-form>
                <div class="btn-group btn-group-justified">

                </div>

            </div>
        </div>

        <div id="about" class="container vertical-center">
            <div class="jumbotron text-left">
                <h2 name="about">About LifeGuide Toolbox</h2>
                <p class="text-justify">
                    The LifeGuide intervention author management tool enables researchers to optimise their interventions prior to deployment in the Google Play or Apple Store digital distribution services as well as other platforms.
                </p>
                <p class="text-justify">
                    For more information on the general LifeGuide project please click <a href="https://www.lifeguideonline.org" target="_blank">here</a>.
                </p>
            </div>
        </div>

        <div id="dashboard" class="container vertical-center">
            <div class="jumbotron text-center">
                <div class="container" ng-show="smCtrl.checkAuthorisation()">
                    <h2>Dashboard</h2>
                    <ul class="nav nav-pills nav-justified">
                        <li class="active">
                            <a href="#interventions" data-toggle="pill">Interventions</a>
                        </li>
                        <li>
                            <a href="#users" data-toggle="pill">Users</a>
                        </li>
                        <li>
                            <a href="#data" data-toggle="pill">Data</a>
                        </li>
                    </ul>
                    <div class="tab-content">

                        <div id="data" class="tab-pane fade">
                            <h3>Data Management</h3>
                            <div class="pull-left">
                                <p>Please click below to download user usage data.</p>
                                <button class="btn btn-primary" ng-click="smCtrl.getUserUsageData()">Download User Usage</button>
                            </div>
                            <div class="pull-right">
                                <p>Please click below to download user response data.</p>
                                <button class="btn btn-primary" ng-click="smCtrl.getUserResponseData()">Download User Response</button>
                            </div>
                        </div>

                        <div id="interventions" class="tab-pane fade in active">
                            <h3>All Interventions</h3>
                            <div id="interventionFeedback"></div>
                            <label>Search:
                                <input ng-model="searchIntervention">
                            </label>
                            <a href="#addIntervention"><span class="glyphicon glyphicon-plus"></span> Add new intervention</a>
                            <div class="table-responsive">
                                <table id="interventionTable" class="table table-striped table-bordered">
                                    <thead class="thead-inverse">
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>ID</th>
                                            <th>Description</th>
                                            <th>Delete Intervention</th>
                                            <th>Update Intervention</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="intervention in smCtrl.interventionList.data | filter:searchIntervention">
                                            <td>{{$index + 1}}</td>
                                            <td>{{intervention.name}}</td>
                                            <td>{{intervention.key}}</td>
                                            <td>{{intervention.description}}</td>
                                            <td>
                                                <input type="button" class="btn btn-danger btn-med" value="Delete" ng-click="smCtrl.deleteIntervention(intervention.key)">
                                            </td>
                                            <td>
                                                <input type="button" id="get_file" class="btn btn-primary btn-med" value="Update" ng-click="smCtrl.updateIntervention(intervention.key)" disabled>
                                                <input type="file" id="my_file">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="users" class="tab-pane fade">
                            <h3>All Users</h3>
                            <div id="userFeedback"></div>
                            <label>Search Users
                                <input ng-model="searchUsers">
                            </label>
                            <div class="table-responsive">
                                <table id="userTable" class="table table-striped table-bordered">
                                    <thead class="thead-inverse">
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>Surname</th>
                                            <th>Username</th>
                                            <th>Intervention</th>
                                            <th>Delete User</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="user in smCtrl.userList.data | filter:searchUsers">
                                            <td>{{$index + 1}}</td>
                                            <td>{{user.name}}</td>
                                            <td>{{user.surname}}</td>
                                            <td>{{user.username}}</td>
                                            <td>{{user.interventionID}}</td>
                                            <td>
                                                <input type="button" class="btn btn-danger btn-med" value="Delete" ng-click="smCtrl.deleteUser(user.username)">
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="text-justify" ng-hide="smCtrl.checkAuthorisation()">
                    <strong>Please Note:</strong> You must be signed in to view this page, please click <a href="#login">here</a> to signin. If you are not registered please click <a href="#register">here</a> to register with us.
                </p>
            </div>
        </div>

        <div id="logout" class="container vertical-center">
            <div class="jumbotron text-center">
                <h2>You have successfully logged out.</h2>
                <p class="text-justify">
                    If you want to sign back in please click <a href="#login">here</a>. If you want to go to the home page please click <a href="#home">here</a>
                </p>
            </div>
        </div>

        <div id="addIntervention" class="container vertical-center">
            <div class="jumbotron text-center">
                <h2>Add Interventions Details</h2>
                <p class="text-justify">
                    <div id="interventionFeedback"></div>
                </p>
                <div class="form-horizontal">
                    <div class="form-group row">
                        <label for="interventionName" class="col-md-2 col-form-label">Name</label>
                        <div class="col-md-5">
                            <input type="text" id="interventionName" ng-model="smCtrl.interventionName" class="form-control" placeholder="name" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="interventionID" class="col-md-2 col-form-label">ID</label>
                        <div class="col-md-5">
                            <input type="text" id="interventionID" ng-model="smCtrl.interventionID" class="form-control" placeholder="id" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="description" class="col-md-2 col-form-label">Description</label>
                        <div class="col-md-5">
                            <textarea id="description" rows="3" ng-model="smCtrl.description" class="form-control" placeholder="description"> </textarea>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="file" class="col-md-2 col-form-label">Select File</label>
                        <div class="col-md-5">
                            <input type="file" id="fileToUpload" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-md-offset-2 col-md-2">
                            <button class="btn btn-primary btn-med" ng-click="smCtrl.interventionUpload()">Save Intervention</button>
                        </div>
                    </div>
                </div>
                <div class="btn-group btn-group-justified">
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <span class="text-muted">&copy; Copyright University of Southampton 2016</span>
        </div>
    </footer>

    <script>
        (function() {
            'use strict';
            angular.module('serverManagementModule', [])
                //https://myhealthresearch.org/server/api
                .constant('API_ENDPOINT', {
                    url: 'http://localhost:8080/api'
                })

                .controller('serverManagementCtrl', function(AuthService, dataManager, $http, $q, API_ENDPOINT) {
                    var vm = this;
                    vm.user = {};
                    vm.newuser = {};
                    vm.fileData = {};
                    vm.interventionVersion = {};
                    var interventionContent = {};
                    var isAuthorised = false;

                    /*
                    vm.checkAuthentication = function () {
                        return AuthService.isAuthenticated();
                    };
                    */

                    // Check that the user is authenticated and authorised
                    vm.checkAuthorisation = function() {
                        if (AuthService.isAuthorised() && AuthService.isAuthenticated()) {
                            isAuthorised = true;
                            return true;
                        } else {
                            return false;
                        }
                    };

                    var parseInterventions = function() {
                        $http.get(API_ENDPOINT.url + '/interventions').then(function(result) {
                            vm.interventionList = result;
                        });
                    };

                    var parseUsers = function() {
                        $http.get(API_ENDPOINT.url + '/users').then(function(result) {
                            vm.userList = result;
                        });
                    };

                    vm.forgotPassword = function(username) {
                        var user = {"username": username};
                        //return $q(function(resolve, reject) {
                        $http.post(API_ENDPOINT.url + '/forgot', user).then(function successCallback(response) {
                            // this callback will be called asynchronously
                            // when the response is available
                            document.getElementById("forgotPasswordFeedback").innerHTML = response.data.msg;
                        }, function errorCallback(response) {
                            // called asynchronously if an error occurs
                            // or server returns response with an error status.
                        });
                        //});
                    };

                    vm.getUserUsageData = function() {
                        $http.get(API_ENDPOINT.url + '/userUsageData').then(function(result) {
                            var userUsageData = JSON.stringify(result.data);
                            console.info(userUsageData);
                            var hiddenElement = document.createElement('a');

                            hiddenElement.href = 'data:attachment/text,' + encodeURI(userUsageData);
                            hiddenElement.target = '_blank';
                            hiddenElement.download = 'userUsageData.txt';
                            hiddenElement.click();
                        });
                    };

                    vm.getUserResponseData = function() {
                        $http.get(API_ENDPOINT.url + '/userResponseData').then(function(result) {
                            var userResponseData = JSON.stringify(result.data);
                            console.info(userResponseData);
                            var hiddenElement = document.createElement('a');

                            hiddenElement.href = 'data:attachment/text,' + encodeURI(userResponseData);
                            hiddenElement.target = '_blank';
                            hiddenElement.download = 'userResponseData.txt';
                            hiddenElement.click();
                        });
                    };

                    vm.deleteIntervention = function(interventionID) {
                        $http.delete(API_ENDPOINT.url + '/intervention/:' + interventionID).then(function(result) {
                            document.getElementById("interventionFeedback").innerHTML = result.data.msg;
                            parseInterventions();
                        }, function(result) {
                            document.getElementById("interventionFeedback").innerHTML = result.data.msg;
                        });
                    };

                    vm.updateIntervention = function(interventionID) {
                        var file = {};
                        setTimeout(function() {
                            document.getElementById('my_file').click();
                            file = document.getElementById('my_file').files[0];
                            //console.log(file);
                        }, 0);

                        if (file) {
                            var reader = new FileReader();
                            reader.onloadend = function(e) {
                                var fileData = e.target.result;
                            };
                            reader.onerror = function(event) {
                                console.error('File could not be read!' + event.target.error.code);
                            };
                        }

                        $http.put(API_ENDPOINT.url + '/intervention/:' + interventionID, fileData).then(function(result) {
                            document.getElementById("interventionFeedback").innerHTML = result.data.msg;
                            parseInterventions();
                        }, function(result) {
                            document.getElementById("interventionFeedback").innerHTML = result.data.msg;
                        });
                    };

                    vm.deleteUser = function(username) {
                        $http.delete(API_ENDPOINT.url + '/user/:' + username).then(function(result) {
                            document.getElementById("userFeedback").innerHTML = result.data.msg;
                            parseUsers();
                        }, function(result) {
                            document.getElementById("userFeedback").innerHTML = result.data.msg;
                        });
                    };

                    vm.interventionUpload = function() {
                        var intervention = {
                            'name': vm.interventionName,
                            'key': vm.interventionID,
                            'description': vm.description,
                            'data': interventionContent
                        }

                        dataManager.saveIntervention(intervention);
                        //Wait for a 1.5 seconds and update the intervention list
                        setTimeout(function() {
                            parseInterventions();
                        }, 1500);
                        //Go to the dashboard page after you have added the intervention
                        setTimeout(function() {
                            window.location.hash = '#dashboard';
                        }, 2000);

                    };

                    angular.element(document.getElementById('fileToUpload')).on('change', function(event) {
                        //angular.element(document).find('input').on('change', function (event) {
                        //console.info('element change event');
                        var file = event.target.files[0];
                        vm.fileName = file.name;
                        var reader = new FileReader();
                        // Closure to capture the file information
                        reader.onload = function(event) {
                            vm.contents = event.target.result;
                            interventionContent = vm.contents;
                            //console.info('File contents: ' + vm.contents);
                        };
                        reader.onerror = function(event) {
                            console.error('File could not be read!' + event.target.error.code);
                        };
                        // Read the file contents as text
                        reader.readAsText(file);
                        //console.info('uploaded file: ' + vm.fileName);
                    });

                    vm.loginUser = function(user) {
                        AuthService.loginUser(user);

                        setTimeout(function() {
                            if (isAuthorised === true) {
                                parseInterventions();
                                parseUsers();
                            }
                        }, 1500);

                        //Go to the dashboard page after user login
                        setTimeout(function() {
                            if (isAuthorised === true) {
                                window.location.hash = '#dashboard';
                            }
                        }, 2000);

                    };

                    vm.registerUser = function(newuser) {
                        // Put this condition (isAuthorised === true) in the if statement
                        if (true) {
                            newuser.role = {
                                admin: true
                            };
                            AuthService.registerUser(newuser);
                        }
                    };

                    vm.logoutUser = function() {
                        AuthService.logout();
                        document.getElementById("loginFeedback").innerHTML = '';
                    };

                    /*
                    vm.parseInterventionList = function () {
                        AuthService.accessSecureArea();
                    };
                    */
                })

                // Check that 2 password fields match
                .directive('pwCheck', [function() {
                    return {
                        require: 'ngModel',
                        link: function(scope, elem, attrs, ctrl) {
                            var firstPassword = '#' + attrs.pwCheck;
                            $(elem).add(firstPassword).on('keyup', function() {
                                scope.$apply(function() {
                                    var v = elem.val() === $(firstPassword).val();
                                    ctrl.$setValidity('pwmatch', v);
                                });
                            });
                        }
                    }
                }])

                .service('dataManager', function($q, $http, API_ENDPOINT) {
                    'use strict';

                    var saveIntervention = function(data) {
                        return $q(function(resolve, reject) {
                            $http.post(API_ENDPOINT.url + '/saveintervention', data).then(function(result) {
                                if (result.data.success) {
                                    resolve(result.data.msg);
                                    document.getElementById("interventionFeedback").innerHTML = result.data.msg;
                                } else {
                                    reject(result.data.msg);
                                    document.getElementById("interventionFeedback").innerHTML = result.data.msg;
                                }
                            });
                        });
                    };

                    return {
                        saveIntervention: saveIntervention
                    };

                })

                .service('AuthService', function($q, $http, API_ENDPOINT) {

                    var LOCAL_TOKEN_KEY = 'yourTokenKey';
                    var username = '';
                    var isAuthenticated = false;
                    var role = {};
                    var authToken;
                    var AUTH_EVENTS = 'auth-not-authenticated';

                    function validateForm() {
                        var x = document.forms["login"]["username"].value;
                        if (x == null || x == "") {
                            alert("Please fill out the username");
                            return false;
                        }
                    }

                    function loginUser(user) {
                        return $q(function(resolve, reject) {
                            $http.post(API_ENDPOINT.url + '/authenticate', user).then(function(result) {
                                if (result.data.success) {
                                    storeUserCredentials(result.data.token);
                                    role = result.data.role;
                                    resolve(result.data.msg);
                                    document.getElementById("loginFeedback").innerHTML = 'Logged in as ' + user.username;

                                    /*
                                    setTimeout(function () {
                                        accessSecureArea();
                                    }, 1000);
                                    */

                                } else {
                                    reject(result.data.msg);
                                    document.getElementById("loginFeedback").innerHTML = result.data.msg;
                                }
                            });
                        });
                    }

                    var accessSecureArea = function() {
                        if (role.admin === true) {
                            $http.get(API_ENDPOINT.url + '/dashboard').then(function(result) {
                                //console.log(result.data.msg);
                            });
                        } else {
                            console.log('Not Authorised to view this page');
                        }
                    };

                    function registerUser(user) {
                        return $q(function(resolve, reject) {
                            $http.post(API_ENDPOINT.url + '/signup', user).then(function(result) {
                                if (result.data.success) {
                                    resolve(result.data.msg);
                                    document.getElementById("registrationFeedback").innerHTML = result.data.msg;
                                } else {
                                    reject(result.data.msg);
                                    document.getElementById("registrationFeedback").innerHTML = result.data.msg;
                                }
                            });
                        });
                    }

                    function storeUserCredentials(token) {
                        window.localStorage.setItem(LOCAL_TOKEN_KEY, token);
                        useCredentials(token);
                    }

                    function useCredentials(token) {
                        username = token.split('.')[0];
                        isAuthenticated = true;
                        authToken = token;

                        if (username == 'admin') {
                            role = USER_ROLES.admin
                        }
                        if (username == 'user') {
                            role = USER_ROLES.public
                        }

                        // Set the token as header for your requests!
                        $http.defaults.headers.common['authorization'] = token;
                    }

                    var logout = function() {
                        destroyUserCredentials();
                    };

                    function destroyUserCredentials() {
                        authToken = undefined;
                        username = '';
                        isAuthenticated = false;
                        $http.defaults.headers.common['authorization'] = undefined; //changed X-Auth-Token to authorization
                        window.localStorage.removeItem(LOCAL_TOKEN_KEY);
                    }

                    var isAuthorised = function() {
                        if (role.admin === true) {
                            return true;
                        } else {
                            return false;
                        }
                    };

                    return {
                        loginUser: loginUser,
                        registerUser: registerUser,
                        logout: logout,
                        accessSecureArea: accessSecureArea,
                        isAuthorised: isAuthorised,
                        isAuthenticated: function() {
                            return isAuthenticated;
                        }
                    };

                });

        }());
    </script>

</body>

</html>
